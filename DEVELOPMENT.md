# KDB-X Tick Development

## KDB-X Table Schema

The tickerplant expects the following table definition:

```q
hass_events:([] time:`timestamp$(); edomain:`$(); entity_id:`$(); evalue:`float$();eattr:())
```

## Tickerplant Update Function

The `.u.updjson` function receives JSON payloads from Home Assistant and inserts them into the tick table.

### Helper: `convertJsonTime`

Converts a Python JSON float timestamp to a KDB+ timestamp:

```q
// @param t float Float time value as generated by Python json converter
// @return timestamp
// @example  convertJsonTime[ (.j.k d)`time]
convertJsonTime:{[t] (`timestamp$1000000000*t)+`long$1970.01.01D00 };
```

### Main function: `.u.updjson`

```q
// @param t symbol The tablename
// @param d char[] Json data (see payload format below)
// @return null
.u.updjson: {[t; d]
  x:@[;`time`domain`entity_id`value`attributes] _[;`host] raze (_;@).\:((.j.k .p.d:d);`event);
  tblData: flip(cols hass_event)!enlist each @ [;(enlist 0); convertJsonTime] @ [;(1 2);(`$)] x;
  .u.upd[t;tblData]
 }
```

### Debug version

```q
.u.updjson:{[t;d] .p.t:t;.p.d:d;0N!(t;d)}
```

### Expected JSON payload format

```json
{
  "time": 1704877539.956502,
  "host": "hass_event",
  "event": {
    "time": 1704877539.956502,
    "domain": "sensor",
    "entity_id": "temperature",
    "attributes": {"unit": "C", "friendly_name": "Temperature"},
    "value": 22.5
  }
}
```
